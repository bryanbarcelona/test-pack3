name: Publish Release

on:
  push:
    branches: [main]

permissions:
  contents: write
  id-token: write

jobs:
  tests:
    uses: ./.github/workflows/ci.yml

  publish:
    needs: tests
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    outputs:
      version: ${{ steps.cz.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/setup-python@v5
      - uses: astral-sh/setup-uv@v3

      - run: uv sync --all-extras --dev --frozen
      - run: uv tool install commitizen

      - name: Bump version, changelog & tag
        id: cz
        uses: commitizen-tools/commitizen-action@0.26.0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          push: true
          changelog: true

      - name: Debug - Show commitizen outputs
        run: |
          echo "::notice::Commitizen version output: '${{ steps.cz.outputs.version }}'"
          echo "::notice::REVISION env var: '${{ env.REVISION }}'"
          echo "Version bumped: ${{ steps.cz.outputs.version != '' }}"

      - name: Build & publish to TestPyPI
        if: steps.cz.outputs.version != ''
        run: |
          echo "::notice::Building and publishing version ${{ steps.cz.outputs.version }}"
          uv build
          uv publish --index testpypi

      - name: Debug - No version bump
        if: steps.cz.outputs.version == ''
        run: echo "::warning::No version bump detected - skipping build/publish"

  release:
    needs: publish
    if: ${{ needs.publish.outputs.version != '' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Debug - Show inherited outputs
        run: |
          echo "::notice::Version from publish job: '${{ needs.publish.outputs.version }}'"
          echo "::notice::Will create release for tag: v${{ needs.publish.outputs.version }}"

      - uses: actions/checkout@v4
        with:
          ref: v${{ needs.publish.outputs.version }}

      - name: Debug - Verify checkout
        run: |
          echo "::notice::Checked out ref: $(git describe --tags --always)"
          echo "::notice::Current commit: $(git rev-parse HEAD)"

      - uses: astral-sh/setup-uv@v3
      - run: uv build

      - name: Debug - List artifacts
        run: |
          echo "::notice::Built artifacts:"
          ls -lh dist/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.publish.outputs.version }}
          generate_release_notes: true
          files: |
            dist/*.whl
            dist/*.tar.gz

      - name: Debug - Release created
        if: success()
        run: echo "::notice::âœ… Release v${{ needs.publish.outputs.version }} created successfully"
