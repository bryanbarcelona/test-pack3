name: Publish Release

on:
  push:
    branches: [main]

permissions:
  contents: write      # needed for tagging + releasing
  id-token: write      # for trusted publishing to PyPI later

jobs:
  tests:
    uses: ./.github/workflows/ci.yml

  publish:
    needs: tests
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    outputs:
      new_tag: ${{ steps.cz.outputs.tag }}
      bumped: ${{ steps.cz.outputs.bumped || steps.cz.outputs.version }}  # ← important fallback
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}   # needed so commitizen can push

      - uses: actions/setup-python@v5
      - uses: astral-sh/setup-uv@v3

      - run: uv sync --all-extras --dev --frozen
      - run: uv tool install commitizen

      - name: Bump version, changelog & tag
        id: cz
        uses: commitizen-tools/commitizen-action@0.26.0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          push: true
          changelog: true

      - name: Build & publish to TestPyPI
        if: steps.cz.outputs.bumped == 'true' || steps.cz.outputs.version != ''
        run: |
          uv build
          uv publish --index testpypi   # remove --index when you go to real PyPI

  # ──────────────────────────────────────────────────────────────
  # This job runs ONLY when a new tag was created → no loops, no duplicates
  # ──────────────────────────────────────────────────────────────
  release:
    needs: publish
    if: ${{ needs.publish.outputs.bumped == 'true' && needs.publish.outputs.new_tag != '' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.publish.outputs.new_tag }}   # checkout the exact tag

      - uses: astral-sh/setup-uv@v3
      - run: uv build   # rebuilds the exact same artifacts that were published

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.publish.outputs.new_tag }}
          generate_release_notes: true
          files: |
            dist/*.whl
            dist/*.tar.gz
